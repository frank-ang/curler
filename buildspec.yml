version: 0.2
phases:
  pre_build:
    commands:
      - echo "Logging in to Amazon ECR"
      - $(aws ecr get-login --no-include-email)
      - AWS_ACCOUNT_ID=$(aws sts get-caller-identity | jq '.Account' | tr -d '"')
      - REPOSITORY_URI="$AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com"
      ## - echo "REPOSITORY_URI $REPOSITORY_URI"
      - TAG="$(echo $CODEBUILD_RESOLVED_SOURCE_VERSION | head -c 8)"
      ##- echo "CODEBUILD_RESOLVED_SOURCE_VERSION $CODEBUILD_RESOLVED_SOURCE_VERSION"
      ##- echo "CODEBUILD_SOURCE_VERSION $CODEBUILD_SOURCE_VERSION"
      - IMAGE_URI="${REPOSITORY_URI}:${TAG}"
      - echo "IMAGE_URI is $IMAGE_URI"
  build:
    commands:
      - echo "Build started on `date -u +%FT%TZ` (ISO-8601)"
      - echo "Building the Docker image"
      - docker build --tag "$IMAGE_URI" .
      ## docker build -t $IMAGE_REPO_NAME:$(printenv CODEBUILD_BUILD_ID | awk -F':' '{print $2}') .

  post_build:
    commands:
      - echo "Build completed on `date -u +%FT%TZ` (ISO-8601)"
      - echo "Pushing the Docker image"
      ##- docker push $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$IMAGE_REPO_NAME:$(printenv CODEBUILD_BUILD_ID | awk -F':' '{print $2}')
      - docker push "$IMAGE_URI"
      - printf '[{"name":"simple-canary","imageUri":"%s"}]' "$IMAGE_URI" > images.json
artifacts:
  files: images.json
